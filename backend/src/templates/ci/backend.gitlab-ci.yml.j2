stages:
  - lint
  - test
  - sonar
  - build
  - migrate
  - deploy

variables:
  UV_CACHE_DIR: "${CI_PROJECT_DIR}/.uv-cache"
  PYTHONPATH: "${CI_PROJECT_DIR}"
  SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"
  GIT_DEPTH: "0"
  DOCKER_IMAGE: "${CI_REGISTRY_IMAGE}"

.uv-setup: &uv-setup
  - pip install uv --quiet
  - uv sync --frozen

.uv-cache: &uv-cache
  key: uv-${CI_COMMIT_REF_SLUG}
  paths:
    - ${UV_CACHE_DIR}
    - .venv/

.default-rules: &default-rules
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

lint:
  stage: lint
  image: python:3.13-slim
  <<: *default-rules
  before_script: *uv-setup
  script:
    - uv run pre-commit run --all-files
  cache:
    <<: *uv-cache
    policy: pull-push

test:
  stage: test
  image: python:3.13-slim
  <<: *default-rules
  services:
    - name: postgres:16-alpine
      alias: postgres
  variables:
    POSTGRES_DB: test_{{ project_name }}
    POSTGRES_USER: postgres
    POSTGRES_PASSWORD: postgres
    DATABASE_URL: "postgresql+asyncpg://postgres:postgres@postgres:5432/test_{{ project_name }}"
  before_script: *uv-setup
  script:
    - uv run alembic upgrade head
    - uv run pytest tests/ --cov=src --cov-report=xml:coverage.xml --cov-report=term --junitxml=report.xml -v
  artifacts:
    reports:
      junit: report.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - coverage.xml
    when: always
    expire_in: 30 days
  coverage: '/(?i)total.*? (100(?:\.0+)?%|[1-9]?\d(?:\.\d+)?%)$/'
  cache:
    <<: *uv-cache
    policy: pull

sonar:
  stage: sonar
  image:
    name: sonarsource/sonar-scanner-cli:11
    entrypoint: [""]
  needs:
    - job: test
      artifacts: true
  <<: *default-rules
  cache:
    key: sonar-${CI_COMMIT_REF_SLUG}
    paths:
      - ${SONAR_USER_HOME}/cache
  script:
    - >-
      sonar-scanner
      -Dsonar.host.url="${SONAR_HOST_URL}"
      -Dsonar.projectKey="{{ project_name }}"
      -Dsonar.sources=src
      -Dsonar.tests=tests
      -Dsonar.python.coverage.reportPaths=coverage.xml
  allow_failure: true

build:
  stage: build
  image: docker:27
  services:
    - docker:27-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build --pull -t ${DOCKER_IMAGE}:${CI_COMMIT_SHORT_SHA} -t ${DOCKER_IMAGE}:latest .
    - docker push ${DOCKER_IMAGE}:${CI_COMMIT_SHORT_SHA}
    - docker push ${DOCKER_IMAGE}:latest
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

.migrate-base:
  stage: migrate
  image: python:3.13-slim
  before_script: *uv-setup
  script:
    - uv run alembic upgrade head
  cache:
    <<: *uv-cache
    policy: pull

migrate:staging:
  extends: .migrate-base
  environment:
    name: staging
  variables:
    DATABASE_URL: $STAGING_DATABASE_URL
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"
 
migrate:production:
  extends: .migrate-base
  environment:
    name: production
  variables:
    DATABASE_URL: $PRODUCTION_DATABASE_URL
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual

.deploy-base:
  stage: deploy
  image: docker:27
  services:
    - docker:27-dind
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker pull ${DOCKER_IMAGE}:${CI_COMMIT_SHORT_SHA}
    - docker tag ${DOCKER_IMAGE}:${CI_COMMIT_SHORT_SHA} ${DOCKER_IMAGE}:${CI_ENVIRONMENT_SLUG}
    - docker push ${DOCKER_IMAGE}:${CI_ENVIRONMENT_SLUG}

deploy:staging:
  extends: .deploy-base
  needs:
    - build
    - migrate:staging
  environment:
    name: staging
  rules:
    - if: $CI_COMMIT_BRANCH == "develop"

deploy:production:
  extends: .deploy-base
  needs:
    - build
    - migrate:production
  environment:
    name: production
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
      when: manual
